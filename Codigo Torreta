#include <Stepper.h>

// --- ConfiguraciÃ³n del motor paso a paso ---
const int pasosPorVuelta = 2048;        // 28BYJ-48 con reducciÃ³n 1/64
Stepper motor(pasosPorVuelta, 8, 10, 9, 11); // Orden de pines correcto

// --- Sensor ultrasÃ³nico HC-SR04 ---
const int pinTrig = 2;
const int pinEcho = 3;

// --- Buzzer ---
const int buzzer = 4;

// --- Control de movimiento ---
int pasos90 = pasosPorVuelta / 4; // â‰ˆ 90Â°
int velocidad = 10;               // Velocidad en RPM
int distanciaDeteccion = 30;      // cm

void setup() {
  Serial.begin(9600);
  motor.setSpeed(velocidad);

  pinMode(pinTrig, OUTPUT);
  pinMode(pinEcho, INPUT);
  pinMode(buzzer, OUTPUT);

  Serial.println("Torreta TERRA 3D iniciando patrulla...");
  delay(2000);
}

void loop() {
  patrullar(1);   // gira 90Â° a la derecha
  patrullar(-1);  // gira 90Â° a la izquierda
}

// --- FunciÃ³n de patrullaje con detecciÃ³n integrada ---
void patrullar(int direccion) {
  for (int i = 0; i < pasos90; i++) {
    motor.step(direccion);  // mueve paso a paso

    // mide distancia cada 10 pasos para no trabar el motor
    if (i % 10 == 0) {
      if (detectarObjeto()) {
        reaccionAlerta();
        break; // salir del bucle actual y continuar con el siguiente movimiento
      }
    }
  }
  delay(300);
}

// --- Mide la distancia y devuelve true si hay algo cerca ---
bool detectarObjeto() {
  long duracion;
  int distancia;

  // Pulso de activaciÃ³n
  digitalWrite(pinTrig, LOW);
  delayMicroseconds(2);
  digitalWrite(pinTrig, HIGH);
  delayMicroseconds(10);
  digitalWrite(pinTrig, LOW);

  // Lectura del eco con timeout de seguridad (para no quedarse colgado)
  duracion = pulseIn(pinEcho, HIGH, 20000); // 20 ms mÃ¡x
  if (duracion == 0) return false;

  distancia = duracion * 0.034 / 2;  // ConversiÃ³n a cm

  Serial.print("Distancia: ");
  Serial.print(distancia);
  Serial.println(" cm");

  // Activa la alerta si hay algo dentro del rango
  return (distancia > 0 && distancia < distanciaDeteccion);
}

// --- ReacciÃ³n ante detecciÃ³n ---
void reaccionAlerta() {
  Serial.println("ðŸš¨ Objeto detectado! Torreta en alerta...");

  // ðŸ”Š Tres pitidos cortos
  for (int i = 0; i < 3; i++) {
    tone(buzzer, 1000);  // tono de 1 kHz
    delay(200);
    noTone(buzzer);
    delay(200);
  }

  delay(1000);  // pausa antes de retomar
  Serial.println("âœ… Patrulla reanudada...");
}
