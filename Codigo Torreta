#include <Stepper.h>

// --- ConfiguraciÃ³n del motor paso a paso ---
const int pasosPorVuelta = 2048;        // 28BYJ-48 con reducciÃ³n 1/64
Stepper motor(pasosPorVuelta, 8, 10, 9, 11);

// --- Sensor ultrasÃ³nico HC-SR04 ---
const int pinTrig = 2;
const int pinEcho = 3;

// --- Buzzer ---
const int buzzer = 4;

// --- Control de movimiento ---
const int pasos90 = pasosPorVuelta / 4; // â‰ˆ 90Â°
const int velocidad = 10;               // Velocidad en RPM
const int distanciaDeteccion = 20;      // cm

// --- Variable global para saber posiciÃ³n actual ---
int posicionActual = 0; // 0 = centro, positivo derecha, negativo izquierda

void setup() {
  Serial.begin(9600);
  motor.setSpeed(velocidad);

  pinMode(pinTrig, OUTPUT);
  pinMode(pinEcho, INPUT);
  pinMode(buzzer, OUTPUT);

  Serial.println("Torreta TERRA 3D iniciando patrulla...");
  delay(2000);
}

void loop() {
  // Barrido derecha
  moverConDeteccion(pasos90);
  // Barrido izquierda
  moverConDeteccion(-pasos90);
}

// --- Mueve el motor en una direcciÃ³n controlada con detecciÃ³n activa ---
void moverConDeteccion(int pasosObjetivo) {
  int direccion = (pasosObjetivo > 0) ? 1 : -1;
  int pasosTotales = abs(pasosObjetivo);

  for (int i = 0; i < pasosTotales; i++) {
    motor.step(direccion);
    posicionActual += direccion; // actualiza posiciÃ³n real

    if (i % 10 == 0 && detectarObjeto()) {
      reaccionAlerta();
      volverAlCentro();
      return; // vuelve al loop() principal desde el centro
    }
  }
  delay(300);
}

// --- Mide la distancia y devuelve true si hay algo cerca ---
bool detectarObjeto() {
  long duracion;
  int distancia;

  digitalWrite(pinTrig, LOW);
  delayMicroseconds(2);
  digitalWrite(pinTrig, HIGH);
  delayMicroseconds(10);
  digitalWrite(pinTrig, LOW);

  duracion = pulseIn(pinEcho, HIGH, 20000);
  if (duracion == 0) return false;

  distancia = duracion * 0.034 / 2;

  Serial.print("Distancia: ");
  Serial.print(distancia);
  Serial.println(" cm");

  return (distancia > 0 && distancia < distanciaDeteccion);
}

// --- ReacciÃ³n ante detecciÃ³n ---
void reaccionAlerta() {
  Serial.println("ðŸš¨ Objeto detectado! Torreta en alerta...");

  for (int i = 0; i < 3; i++) {
    tone(buzzer, 1000);
    delay(200);
    noTone(buzzer);
    delay(200);
  }

  delay(500);
  Serial.println("â†©ï¸ Volviendo al centro...");
}

// --- Regresa a la posiciÃ³n central real ---
void volverAlCentro() {
  int pasosARecuperar = -posicionActual; // cuÃ¡ntos pasos faltan para volver a 0
  int direccion = (pasosARecuperar > 0) ? 1 : -1;

  for (int i = 0; i < abs(pasosARecuperar); i++) {
    motor.step(direccion);
    delay(3);
  }

  posicionActual = 0; // ahora estÃ¡ en el centro
  Serial.println("âœ… Torreta centrada. Patrulla reanudada...");
  delay(1000);
}

